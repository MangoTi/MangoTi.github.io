---
layout:     post   				    # 使用的布局（不需要改）
title:      支付宝IoT小程序踩坑 				# 标题 
subtitle:   收银台支付等问题 #副标题
date:       2019-10-15 				# 时间
author:     XMT 						# 作者
header-img: img/post-bg-2015.jpg 	#这篇文章标题背景图片
catalog: true 						# 是否归档
tags:								#标签
    - 支付宝小程序
---

# 支付宝IoT小程序开发踩坑
最近遇到开发支付宝IoT小程序的需求，实际上就是在刷脸设备上运行的支付宝小程序。刷脸设备目前有三个厂家：马里奥、蜻蜓、商米，底层都是安卓系统，这些机具原生都会具备刷脸支付的功能，都是通过内载IoT小程序实现，虽然可以支付，但是是走支付宝自己通道，如果想走公司的支付通道，就需要再开发小程序进行覆盖。这个二次开发功能支付宝近期才开放出来，可想而知，有很多坑，一开始甚至文档都是找客服要的，并没有开放出来。。现在终于踩过一些坑大致完成了一个版本，在此做一个记录。
## 开发流程
按照文档中的 [小程序接入流程](https://alipay.open.taobao.com/docs/doc.htm?spm=a219a.7629140.0.0.43f54b70RmeOYt&treeId=662&articleId=117880&docType=1#s8 "小程序接入流程") 中1-5步就可以开始开发了，但是要注意的是本地开发调试是默认忽略请求合法性检查的，因此在提交审核前一定要记得添加请求域名白名单，避免在审核中因为这个被驳回。（PS：文档里加的5.3就是因为我们试错后加的= =）调试和预览可以把代码推送到真机上，区别就是预览看不到调试器内容，而且调试和预览在网络不好的时候极其不稳定，容易断开，建议可以在模拟器里调试的就不用真机，不过很多IoT专用的接口只能真机调。

## 接口使用情况
[接口文档](https://alipay.open.taobao.com/docs/doc.htm?spm=a219a.7629140.0.0.5cb24b70yHGx6D&treeId=662&articleId=118285&docType=1 "接口文档")
文档其实还不够完善，提供的接口也不多，这里列举几个值得一提的吧

### 1.打开系统设置页面
```javascript
my.ix.startApp({
  appName: 'settings',
});
```
只能打开最外层的设置页面，无法具体到打开如网络等设置页面
### 2.收银台
```javascript
my.ix.startApp({
  appName: 'cashier',
  bizNo: '12345678',
  totalAmount: '0.01',
  orderDetail: [{ name: '名称1', content: '详情134', fontColor: 'gray' },{ name: '名称2', content: '详情456', fontColor: 'red' }],
  success: (r) => {
    my.showToast({ content: r.barCode });
  }
});
```
注意的点：
1. IoT小程序目前仅支持以唤起原生收银台的方式支付，虽然有扫码接口，但是文档说不可用于支付扫码，目前似乎是可以用来做支付，但是客服说后期可能会关闭支付功能，而且由于刷脸支付只能通过收银台支付，因此做支付只能用这个接口了。

2. 这个接口调用会返回用于支付的barCode，可以在回调中调用支付接口，收银台会自动查询支付结果并显示支付结果页面（刷脸方式），如果需要在退出后有相应操作（如自己展示支付结果），可以调用监听收银台关闭api(my.ix.onCashierEventReceive)，监听到关闭后操作，记得要在退出页面或者其他时机关闭监听。

3. 属性showScanPayResult控制是否显示扫码结果，如果是false，扫码支付不会播报收款且不会显示结果，而刷脸支付会播报与显示。如果showScanPayResult设置为true，就要调用以下接口，并传入要显示的金额等。
```javascript
my.ix.startApp({ appName: 'scanPayResult',  ... };
```
由于要显示实付金额、折扣金额等，该方法要在支付接口回调中调用。
使用该接口还有一个问题就是无法监听到收银台关闭，刷脸时仍然可以在关闭时监听到，而扫码就无法得知关闭时机了。为了解决这个问题，只能设置定时延迟去执行退出后的操作，相当不科学了，算是收银台的bug，希望以后能改正吧。

4. 收银台的error没有详细的列举，扫码没有下一步操作可以不做处理，刷脸会产生以下几个结果：
- 刷脸成功（success:true）
- 刷脸时点击屏幕上的取消按钮（error:1005）
- 未开启刷脸支付关闭或点击“其他支付方式”（error:1005）
- 未识别或直接按键盘上“取消”键（error:1003）
可以判断取消重新唤起收银台。

5. 刷脸支付超过5000无法支付

### 3.连接收银机设备
```javascript
my.ix.writeHID({...})
my.ix.tinyCommand({...});
my.ix.startMonitorTinyCommand(callback);
```
目前还没有成功过，因为没有收银机设备，使用这些接口需要购买专用的双向数据线，否则无法传输数据。

### 4.监听键盘事件
```javascript
my.ix.onKeyEventChange((r) => {
  if (r.keyCode = 131)
  my.showToast({content: 'amount: ' + r.amount});
  else
  my.showToast({content: 'keyCode: ' + r.keyCode});
});
```
能监听到4种行为，其中131用来发起支付，如果双击“收款”会直接选择刷脸方式支付，直接按“刷脸”按钮无法唤起刷脸支付，必须先按“收款”，在按“刷脸”可以选择刷脸，建议做防止重复性点击收款。页面隐藏要关闭监听（my.ix.offKeyEventChange()），或使用文档中给出的方法全局控制。

### 5.缓存存取
```javascript
my.setStorage({
  key: 'currentCity',
  data: {
    cityName: '杭州',
    adCode: '330100',
    spell: ' hangzhou',
  },
  success: function() {
    my.alert({content: '写入成功'});
  }
});
let res = my.getStorageSync({ key: 'currentCity' });
my.alert({
	content: JSON.stringify(res.data),
});
```
存、取、删方法都有同步异步api，可以根据需要选择，需要注意的是，要在使用时再去获取，如果将上方res作为某个页面的全局静态变量，很容易导致数据有时获取不到，因为小程序也许未初始化完成。

## 其他问题
### 1.支付相关
扫码支付超过2000需要输入密码，这种情况支付接口会直接返回支付中，需要轮询支付结果接口，但是收银台超过等待时间已经关闭了，回到小程序后，可弹窗显示支付中，如果用户没有输入密码，取消了订单，接口也无法得知，一直是支付中状态，如果查到了结果则显示。

### 2.返回按钮
小程序的导航栏可以透明，并且不设置标题，能让导航栏存在感降低，但是返回按钮和右上角通用菜单无法隐藏，上线后，小程序页面栈的栈底页面会有一个返回按钮，点击不会退出小程序，非栈底页面的返回按钮能会返回上一层，但是由于导航栏能自定义的只有背景色，如果UI中有返回样式，是无法定制的，如果自己写事件会导致有两个返回按钮，因此最好是使用原生的返回，或者自己的返回按钮不要放在右上角，不诱导用户点击。

